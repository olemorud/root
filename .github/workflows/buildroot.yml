
name: 'Build ROOT multi-platform'

on: 
  workflow_dispatch:
    inputs:
      incremental:
        description: 'Do incremental build'
        required: false
        default: 'true'
      force_generation:
        description: 'Incremental build: Make sure generation step is always run'
        required: false
        default: 'false'
  schedule:
    - cron: '0 1 * * *'


jobs:
  build:
    strategy:
      matrix:
        image: ["fedora32", "fedora34", "centos8", "ubuntu18", "ubuntu20", "ubuntu22"]
        config: ["Release", "Debug", "RelWithDebInfo"]
      fail-fast: false

    runs-on: [self-hosted, linux, x64]

    container:
      image: ghcr.io/olemorud/${{ matrix.image }}:buildready
      options: '--pull=always --security-opt label=disable'
      env:
        OS_APPLICATION_CREDENTIAL_ID: 'fdbb885970e547a49e3dfc339ce1efa7'
        OS_APPLICATION_CREDENTIAL_SECRET: ${{ secrets.OS_APPLICATION_CREDENTIAL_SECRET }}
        OS_AUTH_TYPE: 'v3applicationcredential'
        OS_AUTH_URL: 'https://keystone.cern.ch/v3'
        OS_IDENTITY_API_VERSION: 3
        OS_INTERFACE: 'public'
        OS_REGION_NAME: 'cern'
    
    steps:
      - name: Print debug info
        run:  'printf "%s@%s %s\\n" "$(whoami)" "$(hostname)" "$(pwd)"; ls -Zla; echo ####; ls -Zla /'

      - name: Checkout
        uses: actions/checkout@v3

      - name: Nightly build
        if:   github.event.schedule == '0 1 * * *'
        run: ".github/workflows/rootci-installers/build_root.py --incremental false --buildtype ${{ matrix.config }} --platform ${{ matrix.platform }} --branch master"

      - name: Install root
        run: ".github/workflows/rootci-installers/build_root.py --incremental ${{ inputs.incremental }} --alwaysgenerate ${{ inputs.force_generation }} --buildtype ${{ matrix.config }} --platform ${{ matrix.platform }} --branch master"

