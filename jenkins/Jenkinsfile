pipeline {
    agent {
        node {
            label 'docker-host-noafs'
        }
    }

    parameters{
        string(name: 'BRANCH', defaultValue: 'master', description: 'The branch of root to build')
    }

    stages {
        stage('Build all images') {
            matrix {
                agent {
                    node {
                        label 'docker-host-noafs'
                    }
                }
                axes {
                    axis {
                        name 'IMAGE'
                        values 'ubuntu18', 'ubuntu20', 'ubuntu22', 'centos7', 'centos8',  'fedora34', 'fedora32'
                    }
                }
                stages {
                    stage('Build') {
                        agent {
                            docker {
                                image "ghcr.io/olemorud/${IMAGE}:buildready"
                                args '''
                                    --net=host
                                    --pull=always
                                    -u=root
                                    -e BRANCH=${params.BRANCH}
                                    -e IMAGE=${IMAGE}
                                '''
                                reuseNode true
                            }
                        }
                        steps {
                            
                            sh '''
                                # DEBUGGING
                                ls /cvmfs
                                env
                                date
                            
                                # BUILD
                                cd /tmp/

                                # possibly security risk but can solve git problems
                                # export GIT_SSL_NO_VERIFY=1 

                                for retry in {1..5}; do
                                    git clone -b $BRANCH --single-branch --depth 1 https://github.com/root-project/root.git \
                                    && ERR=false && break
                                done

                                mkdir -p /tmp/build
                                cd /tmp/build

                                # For ROOT version 6.26.00 set `-Druntime_cxxmodules=OFF` (https://github.com/root-project/root/pull/10198)
                                cmake /tmp/root/ -DCMAKE_INSTALL_PREFIX=/usr $OPTIONS

                                cmake --build . --target install -- -j$(nproc)
                            '''
                        }
                    }
                }
                post {
                    failure {
                        echo "TODO: show how to replicate build on failure"
                    }
                }
            }
        }
    }

}
