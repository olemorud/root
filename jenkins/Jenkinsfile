pipeline {
    agent {
        node {
            label 'docker-host-noafs'
        }
    }

    parameters{
        string(name: 'BRANCH', defaultValue: 'master', description: 'The branch of root to build')
        //string(name: 'BUILD_OPTIONS', defaultValue: '', description: 'Options to pass to CMake, e.g. -DCMAKE_CXX_STANDARD=17')
        string(name: 'IMAGE', defaultValue: 'ubuntu22', description: 'The image to build, available images are here: https://github.com/olemorud/root-build-ready')
    }

    stages {
        stage('Set display name'){
            steps {
                script {
                    currentBuild.displayName = "${IMAGE}-${BRANCH}"
                }
            }
        }
        stage('Build') {
            agent {
                docker {
                    image "ghcr.io/olemorud/${params.IMAGE}:buildready"
                    args '''
                        --net=host
                        --pull=always
                        -u=root
                        -e BRANCH=${params.BRANCH}
                    '''
                    reuseNode true
                }
            }
            steps {
                sh '''
                    # DEBUGGING
                    env
                    date
                
                    # BUILD
                    cd /tmp/

                    # possibly security risk but can solve git problems
                    # export GIT_SSL_NO_VERIFY=1 

                    for retry in {1..5}; do
                        git clone -b $BRANCH --single-branch --depth 1 https://github.com/root-project/root.git \
                        && ERR=false && break
                    done

                    mkdir -p /tmp/build
                    cd /tmp/build

                    # For ROOT version 6.26.00 set `-Druntime_cxxmodules=OFF` (https://github.com/root-project/root/pull/10198)
                    cmake /tmp/root/ -DCMAKE_INSTALL_PREFIX=/usr $OPTIONS

                    cmake --build . --target install -- -j$(nproc)
                '''
            }
            post {
                failure {
                    mattermostSend (
                        channel: '#jenkins-notification-test',
                        endpoint: 'https://mattermost.web.cern.ch/hooks/x9pg89zxw78oikemnw5huafn7e',
                        color: 'good',
                        message: 'msg',
                        text: "Build failed - Branch ${BRANCH} on platform ${IMAGE}",
                        icon: 'https://toppng.com/uploads/preview/butthead-acdc-11549475832jltej3r74n.png'
                    )
                }
            }
        }
    }
}
